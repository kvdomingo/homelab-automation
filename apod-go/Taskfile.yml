version: 3

dotenv:
  - ./gitea/.env
  - ./homepage/.env

vars:
  SHORT_SHA:
    sh: git rev-parse --short HEAD

tasks:
  default:
    cmds:
      - task: dev

  dev:
    desc: Run development server
    cmds:
      - air -c .air.toml

  build:
    desc: Build Docker image
    cmds:
      - docker build -t git.lab.kvd.studio/r/apod:{{.SHORT_SHA}} .

  push:
    desc: Push Docker image
    cmds:
      - docker push git.lab.kvd.studio/r/apod:{{.SHORT_SHA}}

  build-and-push:
    desc: Build and push Docker image
    cmds:
      - task: build
      - task: push

  deploy:
    desc: Deploy to prod K8s cluster
    dir: k8s
    cmds:
      - kubectl apply -f application.yaml

  destroy:
    desc: Destroy prod K8s deployment
    dir: k8s
    cmds:
      - kubectl delete -f application.yaml
      - kubectl delete -f namespace.yaml
